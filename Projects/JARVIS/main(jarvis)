import speech_recognition as sr
import webbrowser
import pyttsx3
import musicLibrary
import requests
from openai import OpenAI
from gtts import gTTS
import pygame
import os

recognizer = sr.Recognizer()
engine = pyttsx3.init()
newsapi = os.getenv("OPENAI_API_KEY")

def speak_old(text):
    engine.say(text)
    engine.runAndWait()

def speak(text):
    tts = gTTS(text)
    tts.save('temp.mp3')

# initialize mixer
pygame.mixer.init()

# load the MP3 file (in the same folder, or give full path)
pygame.mixer.music.load("temp.mp3")

# start playback
pygame.mixer.music.play()

# keep the program alive until music finishes playing
while pygame.mixer.music.get_busy():
    pygame.time.Clock().tick(10)

    pygame.mixer.music.unload()
    os.remove("temp.mp3")


def aiprocess(command):
    client = OpenAI(    
   api_key="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",
)

    completion = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "system", "content": "You are virtual assistant named Jarvis, skilled in general tasks like Alexa and Google Cloud. Give short response please"},
        {"role": "user",   "content": command}
    ]
)

    return completion.choices[0].message.content

def processCommand(c):
    c = c.lower()
    if "open instagram" in c:
        webbrowser.open("https://instagram.com")
    elif "open pinterest" in c:
        webbrowser.open("https://pinterest.com")
    elif "open youtube" in c:
        webbrowser.open("https://youtube.com")
    elif "open chrome" in c:
        webbrowser.open("https://chrome.com")
    elif c.startswith("play "):
        song = c.split(" ", 1)[1]
        link = musicLibrary.music.get(song)
        if link:
            webbrowser.open(link)
        else:
            speak(f"Song {song} not found")
    elif "news" in c:
        r = requests.get(f"https://newsapi.org/v2/top-headlines?country=in&category=business&apiKey={newsapi}")
        if r.status_code == 200:
            data = r.json()
            articles = data.get('articles', [])
            for article in articles:
                speak(article.get('title', ''))
        else:
            speak("Sorry, could not fetch news.")
    else:
        # Let openAI or something else handle
        speak("Sorry, command not recognised.")
        output = aiprocess(c)
        speak(output)

if __name__ == "__main__":
    speak("Initializing Jarvis...")
    while True:
        print("Listening for wake word...")
        with sr.Microphone() as source:
            recognizer.adjust_for_ambient_noise(source)
            try:
                audio = recognizer.listen(source, timeout=5, phrase_time_limit=3)
                word = recognizer.recognize_google(audio)
                print("You said:", word)
            except sr.UnknownValueError:
                continue
            except sr.RequestError:
                print("Speech Recognition service error")
                continue
            except sr.WaitTimeoutError:
                continue

        if word.lower() == "jarvis":
            speak("Yes, how may I help you?")
            with sr.Microphone() as source:
                recognizer.adjust_for_ambient_noise(source)
                try:
                    audio = recognizer.listen(source, timeout=5, phrase_time_limit=5)
                    command = recognizer.recognize_google(audio)
                    print("Command:", command)
                    processCommand(command)
                except sr.UnknownValueError:
                    speak("Sorry, I did not catch that.")
                except sr.RequestError:
                    speak("Sorry, speech service failed.")
