import arcade
import random

SCREEN_WIDTH = 900
SCREEN_HEIGHT = 700
SCREEN_TITLE = "Ultimate Space Shooter PRO"

PLAYER_SPEED = 7
BULLET_SPEED = 15
ENEMY_SPEED_MIN = 2
ENEMY_SPEED_MAX = 4
POWERUP_SPEED = 3
SHOOT_INTERVAL = 8
PLAYER_SIZE = 40
BULLET_WIDTH = 6
BULLET_HEIGHT = 20
ENEMY_SIZE = 40
POWERUP_SIZE = 20
EXPLOSION_DURATION = 15
MAX_ESCAPED_ENEMIES = 5

class Star:
    def __init__(self):
        self.x = random.randint(0, SCREEN_WIDTH)
        self.y = random.randint(0, SCREEN_HEIGHT)
        self.size = random.randint(1, 3)
        self.speed = random.uniform(1, 3)
        self.color = arcade.color.WHITE_SMOKE if random.random() < 0.7 else arcade.color.YELLOW

    def update(self):
        self.y -= self.speed
        if self.y < 0:
            self.y = SCREEN_HEIGHT
            self.x = random.randint(0, SCREEN_WIDTH)
            self.size = random.randint(1, 3)

    def draw(self):
        arcade.draw_circle_filled(self.x, self.y, self.size, self.color)

class Player:
    def __init__(self):
        self.center_x = SCREEN_WIDTH // 2
        self.center_y = 60
        self.width = PLAYER_SIZE
        self.height = PLAYER_SIZE
        self.change_x = 0
        self.lives = 3
        self.score = 0
        self.shoot_cooldown = 0
        self.powerup_triple = False

    def update(self, delta_time=1/60):
        self.center_x += self.change_x
        self.center_x = max(self.width//2, min(SCREEN_WIDTH - self.width//2, self.center_x))
        if self.shoot_cooldown > 0:
            self.shoot_cooldown -= 1

    def draw(self):
        # Thruster glow
        arcade.draw_circle_filled(self.center_x, self.center_y - self.height//2, self.width//4, arcade.color.ORANGE)
        # Triangle ship
        arcade.draw_triangle_filled(
            self.center_x, self.center_y + self.height//2,
            self.center_x - self.width//2, self.center_y - self.height//2,
            self.center_x + self.width//2, self.center_y - self.height//2,
            arcade.color.CYAN
        )

class Bullet(arcade.SpriteSolidColor):
    def __init__(self, x, y):
        super().__init__(BULLET_WIDTH, BULLET_HEIGHT, arcade.color.YELLOW)
        self.center_x = x
        self.bottom = y

    def update(self, delta_time=1/60):
        self.center_y += BULLET_SPEED
        if self.bottom > SCREEN_HEIGHT:
            self.remove_from_sprite_lists()

class Enemy:
    def __init__(self, x, y, color, speed, zigzag=False):
        self.center_x = x
        self.center_y = y
        self.width = ENEMY_SIZE
        self.height = ENEMY_SIZE
        self.color = color
        self.speed = speed
        self.zigzag = zigzag
        self.direction = 1
        self.remove = False

    def update(self, delta_time=1/60):
        self.center_y -= self.speed
        if self.zigzag:
            self.center_x += self.direction * 2
            if self.center_x < 20 or self.center_x > SCREEN_WIDTH-20:
                self.direction *= -1
        if self.center_y < 0:
            self.remove = True

    def draw(self):
        arcade.draw_ellipse_filled(self.center_x, self.center_y, self.width, self.height//2, self.color)
        arcade.draw_arc_filled(self.center_x, self.center_y, self.width, self.height, arcade.color.LIGHT_GRAY, 0, 180)
        arcade.draw_circle_filled(self.center_x - self.width//4, self.center_y, 5, arcade.color.RED)
        arcade.draw_circle_filled(self.center_x + self.width//4, self.center_y, 5, arcade.color.RED)

class PowerUp(arcade.SpriteSolidColor):
    def __init__(self, x, y, kind="triple"):
        super().__init__(POWERUP_SIZE, POWERUP_SIZE, arcade.color.GREEN)
        self.center_x = x
        self.center_y = y
        self.kind = kind

    def update(self, delta_time=1/60):
        self.center_y -= POWERUP_SPEED
        if self.top < 0:
            self.remove_from_sprite_lists()

class Explosion(arcade.SpriteSolidColor):
    def __init__(self, x, y, size):
        super().__init__(size, size, arcade.color.ORANGE)
        self.center_x = x
        self.center_y = y
        self.timer = EXPLOSION_DURATION

    def update(self, delta_time=1/60):
        self.timer -= 1
        self.alpha = int(255 * (self.timer / EXPLOSION_DURATION))
        if self.timer <= 0:
            self.remove_from_sprite_lists()

class SpaceShooterPro(arcade.Window):
    def __init__(self):
        super().__init__(SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_TITLE)
        arcade.set_background_color(arcade.color.BLACK)

        self.stars = [Star() for _ in range(100)]
        self.player = Player()
        self.bullet_list = arcade.SpriteList()
        self.enemy_list = []
        self.powerup_list = arcade.SpriteList()
        self.explosion_list = arcade.SpriteList()
        self.frame_count = 0
        self.game_over = False
        self.level = 1
        self.escaped_enemies = 0
        self.keys_pressed = set()
        self.start_screen = True
        self.start_screen_timer = 0

    def setup(self):
        self.player.center_x = SCREEN_WIDTH // 2
        self.player.center_y = 60
        self.player.lives = 3
        self.player.score = 0
        self.player.powerup_triple = False
        self.frame_count = 0
        self.level = 1
        self.game_over = False
        self.escaped_enemies = 0
        self.bullet_list.clear()
        self.enemy_list.clear()
        self.powerup_list.clear()
        self.explosion_list.clear()

    def on_draw(self):
        self.clear()

        # Start screen
        if self.start_screen:
            arcade.draw_text("SPACE SHOOTER", SCREEN_WIDTH//2, SCREEN_HEIGHT//2 + 50,
                             arcade.color.WHITE, 50, anchor_x="center")
            arcade.draw_text("ARROWS LEFT/RIGHT TO MOVE", SCREEN_WIDTH//2, SCREEN_HEIGHT//2,
                             arcade.color.YELLOW, 24, anchor_x="center")
            arcade.draw_text("SPACE TO SHOOT", SCREEN_WIDTH//2, SCREEN_HEIGHT//2 - 50,
                             arcade.color.YELLOW, 24, anchor_x="center")
            return

        for star in self.stars:
            star.draw()

        self.player.draw()
        for enemy in self.enemy_list:
            enemy.draw()
        self.bullet_list.draw()
        self.powerup_list.draw()
        self.explosion_list.draw()

        # UI 
        arcade.draw_lrbt_rectangle_filled(
    left=0,
    right=SCREEN_WIDTH,
    bottom=SCREEN_HEIGHT-40,
    top=SCREEN_HEIGHT,
    color=arcade.color.DARK_SLATE_GRAY
)

        arcade.draw_text(f"Score: {self.player.score}", 10, SCREEN_HEIGHT - 30, arcade.color.WHITE, 18)
        arcade.draw_text(f"Level: {self.level}", SCREEN_WIDTH - 120, SCREEN_HEIGHT - 30, arcade.color.YELLOW, 18)
        arcade.draw_text(f"Escaped: {self.escaped_enemies}/{MAX_ESCAPED_ENEMIES}", SCREEN_WIDTH - 250, SCREEN_HEIGHT - 30, arcade.color.RED, 18)

        for i in range(self.player.lives):
            x = 20 + i*50
            y = SCREEN_HEIGHT - 60
            size = 15
            arcade.draw_triangle_filled(x, y + size, x - size, y - size, x + size, y - size, arcade.color.CYAN)
            arcade.draw_circle_filled(x, y - size//2, size//4, arcade.color.ORANGE)

        if self.game_over:
            arcade.draw_text("GAME OVER", SCREEN_WIDTH//2, SCREEN_HEIGHT//2,
                             arcade.color.RED, 60, anchor_x="center")
            arcade.draw_text("Press R to Restart", SCREEN_WIDTH//2, SCREEN_HEIGHT//2 - 80,
                             arcade.color.WHITE, 24, anchor_x="center")

    def on_update(self, delta_time):
        if self.start_screen:
            self.start_screen_timer += 1
            if self.start_screen_timer >= 3 * 60:
                self.start_screen = False
            return

        if self.game_over:
            return

        self.frame_count += 1
        for star in self.stars:
            star.update()
        self.player.update(delta_time)
        self.bullet_list.update(delta_time)
        self.powerup_list.update(delta_time)
        self.explosion_list.update(delta_time)

        for enemy in self.enemy_list[:]:
            enemy.update(delta_time)
            if enemy.remove:
                self.escaped_enemies += 1
                self.enemy_list.remove(enemy)
                if self.escaped_enemies >= MAX_ESCAPED_ENEMIES:
                    self.game_over = True

        # Shooting
        if arcade.key.SPACE in self.keys_pressed and self.player.shoot_cooldown <= 0:
            self.shoot_bullet()
            self.player.shoot_cooldown = SHOOT_INTERVAL

        # Spawn enemies
        if self.frame_count % max(60 - self.level*2, 20) == 0:
            kind = random.choice(["red", "blue", "green"])
            color = arcade.color.RED if kind=="red" else arcade.color.BLUE if kind=="blue" else arcade.color.GREEN
            enemy = Enemy(random.randint(20, SCREEN_WIDTH-20), SCREEN_HEIGHT + 20, color,
                          random.uniform(ENEMY_SPEED_MIN, ENEMY_SPEED_MAX), zigzag=(kind=="green"))
            self.enemy_list.append(enemy)

        # Spawn powerups
        if self.frame_count % 900 == 0:
            self.powerup_list.append(PowerUp(random.randint(20, SCREEN_WIDTH-20), SCREEN_HEIGHT + 20))

        # Bullet collisions
        for bullet in self.bullet_list[:]:
            for enemy in self.enemy_list[:]:
                if abs(bullet.center_x - enemy.center_x) < (BULLET_WIDTH + enemy.width)/2 and \
                   abs(bullet.center_y - enemy.center_y) < (BULLET_HEIGHT + enemy.height)/2:
                    self.bullet_list.remove(bullet)
                    self.enemy_list.remove(enemy)
                    self.player.score += 10
                    self.explosion_list.append(Explosion(enemy.center_x, enemy.center_y, 30))
                    break

        # Enemy collisions with player
        for enemy in self.enemy_list[:]:
            if abs(self.player.center_x - enemy.center_x) < (PLAYER_SIZE + enemy.width)//2 and \
               abs(self.player.center_y - enemy.center_y) < (PLAYER_SIZE + enemy.height)//2:
                self.enemy_list.remove(enemy)
                self.player.lives -= 1
                self.explosion_list.append(Explosion(self.player.center_x, self.player.center_y, 50))
                if self.player.lives <= 0:
                    self.game_over = True

        # Powerup collisions
        for powerup in self.powerup_list[:]:
            if abs(self.player.center_x - powerup.center_x) < (PLAYER_SIZE + POWERUP_SIZE)//2 and \
               abs(self.player.center_y - powerup.center_y) < (PLAYER_SIZE + POWERUP_SIZE)//2:
                self.powerup_list.remove(powerup)
                if powerup.kind == "triple":
                    self.player.powerup_triple = True
# LEVEL UP
        if self.player.score // 500 > self.level - 1:
            self.level += 1

    def on_key_press(self, key, modifiers):
        self.keys_pressed.add(key)
        if key == arcade.key.LEFT:
            self.player.change_x = -PLAYER_SPEED
        elif key == arcade.key.RIGHT:
            self.player.change_x = PLAYER_SPEED
        elif key == arcade.key.R and self.game_over:
            self.setup()

    def on_key_release(self, key, modifiers):
        self.keys_pressed.discard(key)
        if key in (arcade.key.LEFT, arcade.key.RIGHT):
            self.player.change_x = 0

    def shoot_bullet(self):
        if self.player.powerup_triple:
            self.bullet_list.append(Bullet(self.player.center_x, self.player.center_y + PLAYER_SIZE//2))
            self.bullet_list.append(Bullet(self.player.center_x - 15, self.player.center_y + PLAYER_SIZE//2))
            self.bullet_list.append(Bullet(self.player.center_x + 15, self.player.center_y + PLAYER_SIZE//2))
        else:
            self.bullet_list.append(Bullet(self.player.center_x, self.player.center_y + PLAYER_SIZE//2))

def main():
    window = SpaceShooterPro()
    window.setup()
    arcade.run()

if __name__ == "__main__":
    main()
